<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Smart Mirror</title>
<link rel="icon" type="image/x-icon" href="  https://www.simplehuman.in/cdn/shop/files/ST3004_2ffd446f-be46-4e40-9bae-8762a624a1db_900x900.png?v=1758907879">


<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
  html, body {
    margin: 0; padding: 0; background: black; color: white;
    overflow: hidden; height: 100%; font-family: monospace;
  }
  *{text-shadow: 0 0 20px black;}

  @keyframes shake {
    0% { transform: translate(1px,1px) rotate(0deg);}
    10% { transform: translate(-1px,-2px) rotate(-1deg);}
    20% { transform: translate(-3px,0px) rotate(1deg);}
    30% { transform: translate(3px,2px) rotate(0deg);}
    40% { transform: translate(1px,-1px) rotate(1deg);}
    50% { transform: translate(-1px,2px) rotate(-1deg);}
    60% { transform: translate(-3px,1px) rotate(0deg);}
    70% { transform: translate(3px,1px) rotate(-1deg);}
    80% { transform: translate(-1px,-1px) rotate(1deg);}
    90% { transform: translate(1px,2px) rotate(0deg);}
    100% { transform: translate(1px,-2px) rotate(-1deg);}
  }
  .scare-anim {
    animation: shake 0.5s infinite;
  }

  video { display:none; }
</style>
</head>

<body>
<div id="app" class="w-screen h-screen relative flex flex-col items-center justify-center">

  <div id="setupScreen" class="text-center z-50">
    <h1 class="text-4xl text-cyan-400 mb-8 animate-pulse">SMART MIRROR v2.0</h1>
    <button id="startBtn" class="px-8 py-4 border bg-cyan-900 border-cyan-500 text-cyan-100 rounded hover:bg-cyan-800">
      INITIALIZE SYSTEM
    </button>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="canvas" class="absolute inset-0 w-full h-full"></canvas>

  <div id="mirrorUI" class="absolute inset-0 pointer-events-none p-8 flex flex-col justify-between hidden">
    <div class="flex justify-between items-start">
      <div class="font-mono text-cyan-500 text-sm">
        <div id="time" class="text-4xl text-white mb-2"></div>
        <div id="date"></div>
        <div id="faceStatus" class="mt-2 text-xs opacity-75">FACE_TRACKING: IDLE</div>
        <div id="mouthStatus" class="text-xs opacity-75">QUALITY_ANALYSIS: IDLE</div>
      </div>

      <div id="systemStatus"
        class="font-mono text-xs text-green-500 border border-green-500 px-2 py-1 rounded bg-green-900/20">
        System Standby
      </div>
    </div>

    <div class="w-full flex justify-center mb-12">
      <div id="tip" class="text-2xl font-bold px-6 py-3 rounded text-red-100">
        Calibrating Sensors...
      </div>
    </div>
  </div>

  <div id="scareOverlay" class="absolute inset-0 pointer-events-none flex items-center justify-center z-50 hidden">
    <img id="scareImg"
      src="https://images.voicy.network/Content/Pages/Images/f6ee7f2b-7e8a-49af-bfc8-b28a818a9141-small.png"
      class="w-full h-full object-cover opacity-80 mix-blend-hard-light">
    <div class="absolute inset-0 bg-red-900/30 mix-blend-overlay"></div>
  </div>

</div>

<script>
/* -----------------------------
   GLOBALS
------------------------------*/
const TIPS = [
  "Analyzing facial symmetry...",
  "Skin texture optimal...",
  "Initiating Dental Analysis...",
  "Open your mouth for oral analysis..."
];

let STATE = "SETUP";
let tipInterval = null;
let currentTip = 0;
let faceDetectedOnce = false;
let cameraStarted = false;

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const setupScreen = document.getElementById("setupScreen");
const mirrorUI = document.getElementById("mirrorUI");
const faceStatus = document.getElementById("faceStatus");
const mouthStatus = document.getElementById("mouthStatus");
const systemStatus = document.getElementById("systemStatus");
const tipDiv = document.getElementById("tip");
const timeDiv = document.getElementById("time");
const dateDiv = document.getElementById("date");
const scareOverlay = document.getElementById("scareOverlay");

const scream = new Audio(
  "https://www.myinstants.com/media/sounds/final_60108db6919bc200b087a3a2_239343.mp3"
);

/* -----------------------------
   CLOCK
------------------------------*/
setInterval(() => {
  const now = new Date();
  timeDiv.textContent = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  dateDiv.textContent = now.toLocaleDateString();
}, 1000);

/* -----------------------------
   START SYSTEM
------------------------------*/
document.getElementById("startBtn").addEventListener("click", () => {
  setupScreen.style.display = "none";
  mirrorUI.style.display = "flex";
  systemStatus.textContent = "Online - Activating Sensors";
  startCamera();
});

/* -----------------------------
   RESIZE CANVAS
------------------------------*/
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

/* -----------------------------
   CAMERA + FACEMESH
------------------------------*/
async function startCamera() {
  cameraStarted = true;

  const faceMesh = new FaceMesh({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  faceMesh.onResults(results => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!results.image) return;

    drawMirrored(results.image);

    if (!results.multiFaceLandmarks?.length) return;

    const face = results.multiFaceLandmarks[0];
    faceDetectedOnce = true;

    faceStatus.textContent = "FACE_TRACKING: ACTIVE";
    mouthStatus.textContent = "MOUTH_SENSOR: ACTIVE";
    startTipsIfReady();

    drawFaceMeshScaled(face, results.image);
  });

  const cam = new Camera(video, {
    onFrame: async () => await faceMesh.send({ image: video }),
    width: 1280,
    height: 720
  });

  cam.start();
}

/* -----------------------------
   DRAW MIRRORED VIDEO
------------------------------*/
function drawMirrored(img) {
  const w = canvas.width;
  const h = canvas.height;

  const videoAR = img.width / img.height;
  const canvasAR = w / h;

  let drawW, drawH;
  if (videoAR > canvasAR) {
    drawH = h;
    drawW = h * videoAR;
  } else {
    drawW = w;
    drawH = w / videoAR;
  }

  const x = (w - drawW) / 2;
  const y = (h - drawH) / 2;

  ctx.save();
  ctx.translate(w, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(img, x, y, drawW, drawH);
  ctx.restore();
}

/* -----------------------------
   DRAW SCALED LANDMARKS (THINNER + TRANSLUCENT)
------------------------------*/
function drawFaceMeshScaled(face, img) {
  const w = canvas.width;
  const h = canvas.height;

  const videoAR = img.width / img.height;
  const canvasAR = w / h;

  let drawW, drawH;
  if (videoAR > canvasAR) {
    drawH = h;
    drawW = h * videoAR;
  } else {
    drawW = w;
    drawH = w / videoAR;
  }

  const offsetX = (w - drawW) / 2;
  const offsetY = (h - drawH) / 2;

  ctx.save();
  ctx.translate(w, 0);
  ctx.scale(-1, 1);

  function scale(pt) {
    return {
      x: offsetX + pt.x * drawW,
      y: offsetY + pt.y * drawH
    };
  }

  const scaled = face.map(scale);

  // ultra thin and translucent
  drawConnectors(ctx, scaled, FACEMESH_TESSELATION, {
    color: "rgba(0,255,0,0.05)",
    lineWidth: 0.2
  });

  drawConnectors(ctx, scaled, FACEMESH_FACE_OVAL, {
    color: "rgba(0,255,0,0.25)",
    lineWidth: 0.6
  });

  ctx.restore();

  // Mouth detection
  const up = scaled[13];
  const low = scaled[14];
  const L = scaled[61];
  const R = scaled[291];

  const ratio = Math.abs(up.y - low.y) / Math.abs(L.x - R.x);

  if (currentTip === 3 && ratio > 0.40) {
    triggerScare();
  }
}

/* -----------------------------
   TIPS AFTER FACE DETECTED
------------------------------*/
function startTipsIfReady() {
  if (tipInterval || !faceDetectedOnce || !cameraStarted) return;

  systemStatus.textContent = "Sensors Locked";
  tipDiv.textContent = TIPS[0];

  tipInterval = setInterval(() => {
    if (currentTip < TIPS.length - 1) {
      currentTip++;
      tipDiv.textContent = TIPS[currentTip];
    }
  }, 2000);
}

/* -----------------------------
   SCARE EVENT
------------------------------*/
function triggerScare() {
  if (STATE === "SCARE") return;
  STATE = "SCARE";

  clearInterval(tipInterval);
  tipDiv.textContent = "";
  scareOverlay.style.display = "flex";
  canvas.classList.add("scare-anim");

  scream.currentTime = 0;
  scream.play().catch(() => {});

  setTimeout(() => {
    STATE = "MIRROR";
    scareOverlay.style.display = "none";
    canvas.classList.remove("scare-anim");

    currentTip = 0;
    tipDiv.textContent = TIPS[0];

    tipInterval = setInterval(() => {
      if (currentTip < 3) currentTip++;
      tipDiv.textContent = TIPS[currentTip];
    }, 2000);

  }, 3000);
}
</script>
</body>
</html>
