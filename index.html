<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Smart Mirror</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<style>
  html, body { margin: 0; padding: 0; background: black; color: white; overflow: hidden; height: 100%; font-family: monospace; }
  @keyframes shake {
    0% { transform: translate(1px,1px) rotate(0deg);}
    10% { transform: translate(-1px,-2px) rotate(-1deg);}
    20% { transform: translate(-3px,0px) rotate(1deg);}
    30% { transform: translate(3px,2px) rotate(0deg);}
    40% { transform: translate(1px,-1px) rotate(1deg);}
    50% { transform: translate(-1px,2px) rotate(-1deg);}
    60% { transform: translate(-3px,1px) rotate(0deg);}
    70% { transform: translate(3px,1px) rotate(-1deg);}
    80% { transform: translate(-1px,-1px) rotate(1deg);}
    90% { transform: translate(1px,2px) rotate(0deg);}
    100% { transform: translate(1px,-2px) rotate(-1deg);}
  }
  .scare-anim { animation: shake 0.5s infinite; }
</style>
</head>
<body>
<div id="app" class="w-screen h-screen relative flex flex-col items-center justify-center">
  <!-- SETUP SCREEN -->
  <div id="setupScreen" class="text-center z-50">
    <h1 class="text-4xl text-cyan-400 mb-8 animate-pulse">SMART MIRROR v2.0</h1>
    <button id="startBtn" class="px-8 py-4 border bg-cyan-900 border-cyan-500 text-cyan-100 font-mono rounded hover:bg-cyan-800">INITIALIZE SYSTEM</button>
  </div>

  <!-- VIDEO AND CANVAS -->
  <video id="video" class="hidden" playsinline muted></video>
  <canvas id="canvas" width="1280" height="720" class="absolute inset-0 w-full h-full object-cover"></canvas>

  <!-- MIRROR UI -->
  <div id="mirrorUI" class="absolute inset-0 pointer-events-none p-8 flex flex-col justify-between hidden">
    <div class="flex justify-between items-start">
      <div class="font-mono text-cyan-500 text-sm">
        <div id="time" class="text-4xl text-white mb-2"></div>
        <div id="date"></div>
        <div id="faceStatus" class="mt-2 text-xs opacity-75">FACE_TRACKING: CALIBRATING...</div>
        <div id="mouthStatus" class="text-xs opacity-75">QUALITY_ANALYSIS: PENDING</div>
      </div>
      <div id="systemStatus" class="font-mono text-xs text-green-500 border border-green-500 px-2 py-1 rounded bg-green-900/20">System Standby</div>
    </div>
    <div class="w-full flex justify-center mb-12">
      <div id="tip" class="font-sans text-2xl font-bold tracking-wide px-6 py-3 rounded text-cyan-100"></div>
    </div>
  </div>

  <!-- SCARE OVERLAY -->
  <div id="scareOverlay" class="absolute inset-0 pointer-events-none flex items-center justify-center z-50 hidden">
    <img id="scareImg" src="https://images.voicy.network/Content/Pages/Images/f6ee7f2b-7e8a-49af-bfc8-b28a818a9141-small.png?auto=compress&auto=format&h=186&lossless=true" 
    class="w-full h-full object-cover opacity-80 mix-blend-hard-light">
    <div class="absolute inset-0 bg-red-900/30 mix-blend-overlay"></div>
  </div>
</div>

<script>
const TIPS = [
  "Analyzing facial symmetry...",
  "Skin texture optimal...",
  "Initiating Dental Analysis...",
  "Open your mouth for oral analysis..."
];
const SCARE_IMAGE_URL = "https://images.voicy.network/Content/Pages/Images/f6ee7f2b-7e8a-49af-bfc8-b28a818a9141-small.png?auto=compress&auto=format&h=186&lossless=true";
const SCREAM_URL = 'https://www.myinstants.com/media/sounds/final_60108db6919bc200b087a3a2_239343.mp3';

let appState = "SETUP"; // SETUP, MIRROR, SCARE
let currentTip = 0;
let isCameraReady = false;
let tipInterval = null;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const setupScreen = document.getElementById('setupScreen');
const mirrorUI = document.getElementById('mirrorUI');
const scareOverlay = document.getElementById('scareOverlay');
const tipDiv = document.getElementById('tip');
const timeDiv = document.getElementById('time');
const dateDiv = document.getElementById('date');
const faceStatus = document.getElementById('faceStatus');
const mouthStatus = document.getElementById('mouthStatus');
const systemStatus = document.getElementById('systemStatus');

const screamAudio = new Audio(SCREAM_URL);
screamAudio.preload = 'auto';

function updateTime() {
  const now = new Date();
  timeDiv.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  dateDiv.textContent = now.toLocaleDateString();
}
setInterval(updateTime, 1000);

document.getElementById('startBtn').addEventListener('click', async () => {
  await screamAudio.play().catch(()=>{}); // unlock audio
  screamAudio.pause(); screamAudio.currentTime=0;

  setupScreen.style.display = 'none';
  mirrorUI.style.display = 'flex';
  appState = "MIRROR";
  systemStatus.textContent = "Online - Visual Sensors Active";

  // Start tips
  tipInterval = setInterval(()=>{
    if(currentTip < TIPS.length-1) currentTip++;
    tipDiv.textContent = TIPS[currentTip];
    // Change color to red for 4th tip
    if(currentTip === 3) {
      tipDiv.classList.add('text-red-500');
    } else {
      tipDiv.classList.remove('text-red-500');
    }
  },2000);

  startCamera();
});

function triggerScare() {
  if(appState==="SCARE") return;
  appState="SCARE";
  clearInterval(tipInterval);
  tipDiv.textContent = "";
  tipDiv.classList.remove('text-red-500');
  scareOverlay.style.display='flex';
  canvas.classList.add('scare-anim');
  screamAudio.currentTime=0;
  screamAudio.play().catch(()=>{});

  setTimeout(()=>{
    appState="MIRROR";
    scareOverlay.style.display='none';
    canvas.classList.remove('scare-anim');
    currentTip=0;
    tipDiv.textContent = TIPS[currentTip];
    tipDiv.classList.remove('text-red-500');
    tipInterval = setInterval(()=>{
      if(currentTip < TIPS.length-1) currentTip++;
      tipDiv.textContent = TIPS[currentTip];
      if(currentTip === 3) {
        tipDiv.classList.add('text-red-500');
      } else {
        tipDiv.classList.remove('text-red-500');
      }
    },2000);
  },3000);
}

async function startCamera() {
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });
  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  faceMesh.onResults(results => {
    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.translate(canvas.width,0);
    ctx.scale(-1,1);
    if(results.image) ctx.drawImage(results.image,0,0,canvas.width,canvas.height);

    if(results.multiFaceLandmarks?.length>0){
      if(!isCameraReady){
        isCameraReady=true;
        faceStatus.textContent="FACE_TRACKING: ACTIVE";
        mouthStatus.textContent="MOUTH_SENSOR: ACTIVE";
      }
      const l = results.multiFaceLandmarks[0];

      // Draw mesh
      drawConnectors(ctx, l, FACEMESH_TESSELATION,{color:'#00FF0011', lineWidth:1});
      drawConnectors(ctx, l, FACEMESH_RIGHT_EYE,{color:'#00FF00', lineWidth:1});
      drawConnectors(ctx, l, FACEMESH_LEFT_EYE,{color:'#00FF00', lineWidth:1});
      drawConnectors(ctx, l, FACEMESH_FACE_OVAL,{color:'#00FF0055', lineWidth:1});

      // Mouth open detection
      const upperLip=l[13], lowerLip=l[14], left=l[61], right=l[291];
      const ratio = Math.abs(upperLip.y-lowerLip.y)/Math.abs(left.x-right.x);
      if(ratio>0.4 && currentTip===3) triggerScare();
    }
    ctx.restore();
  });

  const cameraMP = new Camera(video, {
    onFrame: async ()=>{ await faceMesh.send({image: video}); },
    width:1280, height:720
  });
  cameraMP.start();
}
</script>
</body>
</html>
